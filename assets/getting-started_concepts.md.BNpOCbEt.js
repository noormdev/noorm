import{_ as i,c as a,o as e,a6 as n}from"./chunks/framework.YF6eQPX_.js";const c=JSON.parse('{"title":"Concepts","description":"","frontmatter":{},"headers":[],"relativePath":"getting-started/concepts.md","filePath":"getting-started/concepts.md"}'),t={name:"getting-started/concepts.md"};function l(h,s,p,r,k,d){return e(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="concepts" tabindex="-1">Concepts <a class="header-anchor" href="#concepts" aria-label="Permalink to “Concepts”">​</a></h1><p>This page explains how noorm thinks about your database. Understanding these concepts makes everything else click.</p><h2 id="sql-files-are-your-source-of-truth" tabindex="-1">SQL Files Are Your Source of Truth <a class="header-anchor" href="#sql-files-are-your-source-of-truth" aria-label="Permalink to “SQL Files Are Your Source of Truth”">​</a></h2><p>Your SQL files define what your schema <strong>is</strong>. They represent the ideal, current state of your database structure.</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>sql/</span></span>
<span class="line"><span>├── 01_tables/</span></span>
<span class="line"><span>│   ├── 001_users.sql    # CREATE TABLE users...</span></span>
<span class="line"><span>│   └── 002_posts.sql    # CREATE TABLE posts...</span></span>
<span class="line"><span>└── 02_views/</span></span>
<span class="line"><span>    └── 001_recent_posts.sql # CREATE VIEW recent_posts...</span></span></code></pre></div><p>Need a fresh database? Run your SQL files. They contain everything needed to build your schema from scratch—no need to replay years of migrations.</p><p>This is different from migration-based tools where the &quot;current state&quot; only exists by running every migration in order. With noorm, your SQL files <strong>are</strong> the current state.</p><h2 id="execution-order-is-alphanumeric" tabindex="-1">Execution Order Is Alphanumeric <a class="header-anchor" href="#execution-order-is-alphanumeric" aria-label="Permalink to “Execution Order Is Alphanumeric”">​</a></h2><p>Everything runs in alphanumeric order. Directories, files within directories, change scripts—all sorted the same way.</p><p>This matters because dependencies have order. Tables must exist before views reference them. Functions must exist before triggers call them. Without numeric prefixes, you get alphabetical order:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>sql/functions/   ← runs first (f &lt; t &lt; v)</span></span>
<span class="line"><span>sql/tables/      ← runs second</span></span>
<span class="line"><span>sql/views/       ← runs third</span></span></code></pre></div><p>That&#39;s broken—views can&#39;t reference tables that don&#39;t exist yet. Use numeric prefixes:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>sql/01_tables/   ← runs first</span></span>
<span class="line"><span>sql/02_views/    ← runs second</span></span>
<span class="line"><span>sql/03_functions/ ← runs third (functions can reference tables/views)</span></span></code></pre></div><p>The same rule applies to files within directories:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>01_tables/</span></span>
<span class="line"><span>├── 01_users.sql     ← runs first</span></span>
<span class="line"><span>├── 02_posts.sql     ← runs second (can reference users)</span></span>
<span class="line"><span>└── 03_comments.sql  ← runs third (can reference posts)</span></span></code></pre></div><p>And to change scripts:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>change/</span></span>
<span class="line"><span>├── 001_create_table.sql</span></span>
<span class="line"><span>├── 002_add_indexes.sql</span></span>
<span class="line"><span>└── 003_seed_data.sql</span></span></code></pre></div><p>One rule, everywhere. Look at the filesystem and you know the order.</p><h2 id="changes-are-your-changelog" tabindex="-1">Changes Are Your Changelog <a class="header-anchor" href="#changes-are-your-changelog" aria-label="Permalink to “Changes Are Your Changelog”">​</a></h2><p>Changes document what you did to evolve an existing database. They answer: who changed what, when, and why.</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>changes/</span></span>
<span class="line"><span>└── 2024-01-15-add-user-roles/</span></span>
<span class="line"><span>    ├── change/</span></span>
<span class="line"><span>    │   └── 001_add_role_column.sql</span></span>
<span class="line"><span>    └── revert/</span></span>
<span class="line"><span>        └── 001_remove_role_column.sql</span></span></code></pre></div><p>When you need to add a column to an existing production database, you don&#39;t just edit the SQL file—you also write a change that performs the <code>ALTER TABLE</code>.</p><h2 id="templates-turn-configuration-into-sql" tabindex="-1">Templates Turn Configuration Into SQL <a class="header-anchor" href="#templates-turn-configuration-into-sql" aria-label="Permalink to “Templates Turn Configuration Into SQL”">​</a></h2><p>Sometimes you need more than static SQL. Templates let you generate SQL from structured data—define your rules in YAML, JSON, or CSV, and let noorm write the repetitive SQL for you.</p><p>Add <code>.tmpl</code> to any SQL file to make it a template:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>sql/</span></span>
<span class="line"><span>├── tables/</span></span>
<span class="line"><span>│   └── users.sql           # Static SQL</span></span>
<span class="line"><span>└── security/</span></span>
<span class="line"><span>    ├── rls.yml             # Configuration data</span></span>
<span class="line"><span>    └── rls.sql.tmpl        # Template that reads it</span></span></code></pre></div><p>Templates can read adjacent data files. Place a <code>rls.yml</code> next to <code>rls.sql.tmpl</code>, and the data is available as <code>rls</code> in your template.</p><p>Here&#39;s a real example: PostgreSQL Row-Level Security. Without templates, you&#39;d write dozens of similar <code>CREATE POLICY</code> statements. With templates, you define policies in YAML:</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># sql/security/rls.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">policies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">users_own_data</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ALL</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">user_id = current_user_id()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    posts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">posts_read_public</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SELECT</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">is_public = true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">posts_owner_write</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ALL</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">author_id = current_user_id()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    comments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">comments_read_if_post_visible</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SELECT</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">              EXISTS (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                  SELECT 1 FROM posts</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                  WHERE posts.id = comments.post_id</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                  AND (posts.is_public OR posts.author_id = current_user_id())</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">              )</span></span></code></pre></div><p>Then generate all the SQL:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- sql/security/rls.sql.tmpl</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{% </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (const [table, policies] of </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">entries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rls</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">policies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) { %}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {%~ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENABLE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ROW</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LEVEL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SECURITY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{% </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (const </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">policy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> of policies) { %}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DROP</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> IF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> EXISTS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {%~ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">policy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {%~ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %};</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {%~ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">policy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {%~ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    FOR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {%~ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">policy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ({%~ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">policy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %});</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{% } %}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{% } %}</span></span></code></pre></div><p>This generates correct, complete SQL for every table. Add a new policy? Edit the YAML. The template handles the boilerplate.</p><p>You can also define <strong>helper functions</strong> in <code>$helpers.ts</code> files. Helpers are inherited up the directory tree—define utilities at the root, specialize them in subdirectories:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// sql/$helpers.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grantAll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">role</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tables</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tables</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`GRANT SELECT, INSERT, UPDATE, DELETE ON \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} TO \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">role</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">};\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- sql/security/grants.sql.tmpl</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{%~ $.grantAll(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;app_user&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [&#39;users&#39;, &#39;posts&#39;, &#39;comments&#39;]) %}</span></span></code></pre></div><p>Templates are powerful for:</p><ul><li><strong>Row-level security policies</strong> - Define access rules, generate USING/CHECK clauses</li><li><strong>Role permissions</strong> - List roles and grants in YAML, generate GRANT/REVOKE statements</li><li><strong>Scheduled jobs</strong> - Define cron schedules in YAML, generate pg_cron or SQL Agent setup</li><li><strong>Seed data</strong> - Store reference data in CSV, generate INSERT statements</li><li><strong>Custom types</strong> - Define domain constraints in YAML, generate CREATE DOMAIN statements</li></ul><p>The pattern is always the same: human-readable configuration goes in a data file, repetitive SQL comes out of the template.</p><h2 id="the-workflow" tabindex="-1">The Workflow <a class="header-anchor" href="#the-workflow" aria-label="Permalink to “The Workflow”">​</a></h2><ol><li><strong>Update your SQL files first.</strong> They should always reflect the ideal schema.</li><li><strong>Write a change</strong> to evolve existing databases to match.</li></ol><p>Your SQL files stay in sync with reality. Changes track how you got there.</p><div class="tip custom-block"><p class="custom-block-title">Fresh vs Existing</p><ul><li><strong>Fresh database</strong> → Run SQL files with <code>noorm run build</code></li><li><strong>Existing database</strong> → Apply changes with <code>noorm change ff</code></li></ul></div><h2 id="configs" tabindex="-1">Configs <a class="header-anchor" href="#configs" aria-label="Permalink to “Configs”">​</a></h2><p>A <strong>config</strong> is a saved database connection. You can have multiple configs for different environments:</p><ul><li><code>dev</code> - Your local database</li><li><code>test</code> - Test database (gets wiped between runs)</li><li><code>staging</code> - Staging server</li><li><code>prod</code> - Production (protected)</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>┌─ Configs ─────────────────────────────┐</span></span>
<span class="line"><span>│  • dev        sqlite   ./data/dev.db  │</span></span>
<span class="line"><span>│    staging    postgres db.staging.com │</span></span>
<span class="line"><span>│    prod       postgres db.prod.com    │</span></span>
<span class="line"><span>└───────────────────────────────────────┘</span></span></code></pre></div><p>The dot (•) shows which config is active. All commands use the active config unless you specify otherwise.</p><p>Switch configs:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">noorm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> use</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> staging</span></span></code></pre></div><p>Or specify per-command:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">noorm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span></code></pre></div><h2 id="protected-configs" tabindex="-1">Protected Configs <a class="header-anchor" href="#protected-configs" aria-label="Permalink to “Protected Configs”">​</a></h2><p>Some configs are marked as <strong>protected</strong>. This prevents accidental destructive operations:</p><ul><li><code>db teardown</code> - Blocked on protected configs</li><li><code>db truncate</code> - Requires confirmation</li><li>Accidental <code>DROP TABLE</code> - Still executes (be careful!)</li></ul><p>Protection is a safety net, not a security boundary. It catches mistakes like running teardown against the wrong database.</p><h2 id="secrets" tabindex="-1">Secrets <a class="header-anchor" href="#secrets" aria-label="Permalink to “Secrets”">​</a></h2><p>Secrets are sensitive values that get inserted <strong>into</strong> your database via SQL templates. They&#39;re for application configuration you store in the database:</p><ul><li>AWS credentials (access key, secret key)</li><li>SMTP credentials for sending emails</li><li>API keys for third-party services</li></ul><p>noorm stores secrets encrypted in your local state. When you run SQL templates, secrets are available but never written to disk in plain text.</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- sql/config/aws.sql.tmpl</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> app_config (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VALUES</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aws_access_key&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;{%~ $.secrets.AWS_ACCESS_KEY %}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aws_secret_key&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;{%~ $.secrets.AWS_SECRET_KEY %}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Set a secret for the current config</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">noorm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secret</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AWS_ACCESS_KEY</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">noorm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secret</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AWS_SECRET_KEY</span></span></code></pre></div><p>When you rebuild your database, your credentials are always there—but never exposed in your SQL files or version control.</p><p>Secrets are <strong>config-scoped</strong>. Each config has its own set of secrets (dev AWS vs prod AWS). There are also <strong>global secrets</strong> shared across all configs.</p><h2 id="state-and-identity" tabindex="-1">State and Identity <a class="header-anchor" href="#state-and-identity" aria-label="Permalink to “State and Identity”">​</a></h2><p>Your <strong>identity</strong> lives in <code>~/.noorm/identity.json</code> along with your public and private keys. These are machine-local and never shared.</p><p>Your <strong>state</strong> lives in <code>.noorm/state/state.enc</code> and contains:</p><ul><li>Your saved configs (database credentials)</li><li>Secrets (encrypted with your keys)</li></ul><p>State is encrypted with your identity keys. It&#39;s not portable between machines—each developer has their own configs and secrets.</p><div class="warning custom-block"><p class="custom-block-title">Don&#39;t Commit state.enc</p><p>Add <code>.noorm/state/state.enc</code> to <code>.gitignore</code>. It contains machine-specific encrypted data that won&#39;t work on other machines anyway.</p></div><h2 id="settings" tabindex="-1">Settings <a class="header-anchor" href="#settings" aria-label="Permalink to “Settings”">​</a></h2><p>Settings live in <code>.noorm/settings.yml</code> and <strong>should be committed</strong>. They define project-wide behavior:</p><ul><li>Schema and changes directory paths</li><li>Build include/exclude patterns</li><li>Stage definitions</li><li>Secret requirements</li></ul><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># .noorm/settings.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">paths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./sql</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  changes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./changes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  include</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">tables</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">views</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">functions</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">stages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  prod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    secrets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">AWS_SECRET_KEY</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        required</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><p>The <code>include</code> array filters which folders are included in builds. Execution order is alphanumeric—use numeric prefixes (<code>01_tables</code>, <code>02_views</code>) to control the sequence. Paths are relative to your <code>paths.sql</code> directory.</p><h2 id="stages" tabindex="-1">Stages <a class="header-anchor" href="#stages" aria-label="Permalink to “Stages”">​</a></h2><p>A <strong>stage</strong> is a template for configs. When you create a config and assign it to a stage, it inherits the stage&#39;s defaults:</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">stages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  development</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    dialect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">sqlite</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    isTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  production</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    dialect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">postgres</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    secrets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">AWS_SECRET_KEY</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        required</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><p>Now when you create a config with stage <code>production</code>, it&#39;s automatically protected and requires an <code>AWS_SECRET_KEY</code> secret.</p><h2 id="sql-files-vs-changes" tabindex="-1">SQL Files vs Changes <a class="header-anchor" href="#sql-files-vs-changes" aria-label="Permalink to “SQL Files vs Changes”">​</a></h2><table tabindex="0"><thead><tr><th>Aspect</th><th>SQL Files</th><th>Changes</th></tr></thead><tbody><tr><td>Purpose</td><td>Define ideal schema</td><td>Evolve existing databases</td></tr><tr><td>Location</td><td><code>sql/</code></td><td><code>changes/</code></td></tr><tr><td>When to run</td><td>Fresh database, tests</td><td>Existing database</td></tr><tr><td>Rollback</td><td>No</td><td>Yes, with revert scripts</td></tr><tr><td>Order</td><td>Settings-defined, then alphabetical</td><td>By date prefix</td></tr></tbody></table><p><strong>SQL files</strong> are your source of truth. They define what your schema looks like today. Execution order is first determined by folder order in your settings, then alphabetically within each folder.</p><p><strong>Changes</strong> are your changelog. They document how to get an existing database to match your SQL files.</p><h2 id="what-s-next" tabindex="-1">What&#39;s Next? <a class="header-anchor" href="#what-s-next" aria-label="Permalink to “What&#39;s Next?”">​</a></h2><ul><li><a href="/getting-started/building-your-sdk.html">Building Your SDK</a> - Wrap noorm in a TypeScript SDK for your apps</li><li><a href="/tui.html">TUI Quick Reference</a> - Navigate the terminal interface</li><li><a href="/guide/sql-files/templates.html">SQL Templates</a> - Dynamic SQL generation</li><li><a href="/guide/changes/overview.html">Changes Guide</a> - Evolving existing databases</li></ul>`,84)])])}const g=i(t,[["render",l]]);export{c as __pageData,g as default};
