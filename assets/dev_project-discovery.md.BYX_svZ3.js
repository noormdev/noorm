import{_ as i,c as a,o as t,a6 as e}from"./chunks/framework.YF6eQPX_.js";const c=JSON.parse('{"title":"Project Discovery","description":"","frontmatter":{},"headers":[],"relativePath":"dev/project-discovery.md","filePath":"dev/project-discovery.md"}'),n={name:"dev/project-discovery.md"};function h(p,s,l,r,o,k){return t(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="project-discovery" tabindex="-1">Project Discovery <a class="header-anchor" href="#project-discovery" aria-label="Permalink to “Project Discovery”">​</a></h1><h2 id="the-problem" tabindex="-1">The Problem <a class="header-anchor" href="#the-problem" aria-label="Permalink to “The Problem”">​</a></h2><p>Users don&#39;t always run noorm from the project root. They might be in <code>~/projects/myapp/packages/db/</code> when they type <code>noorm change ff</code>. The CLI needs to find the project&#39;s <code>.noorm/</code> directory regardless of where the user is.</p><p>But there&#39;s a complication: <code>~/.noorm/</code> exists too. That&#39;s the global directory for identity keys and secrets—not a project. The CLI must distinguish between &quot;user&#39;s global noorm&quot; and &quot;actual project&quot;.</p><h2 id="how-discovery-works" tabindex="-1">How Discovery Works <a class="header-anchor" href="#how-discovery-works" aria-label="Permalink to “How Discovery Works”">​</a></h2><p>When noorm starts, it walks up the directory tree from the current working directory:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>~/projects/myapp/packages/db/     &lt;- user runs noorm here</span></span>
<span class="line"><span>~/projects/myapp/packages/        &lt;- no .noorm, keep walking</span></span>
<span class="line"><span>~/projects/myapp/                 &lt;- found .noorm/ → project root!</span></span></code></pre></div><p>The walk stops at the user&#39;s home directory. If <code>.noorm/</code> is only found in <code>~/</code>, that&#39;s the global directory—not a project.</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>~/projects/newapp/src/            &lt;- user runs noorm here</span></span>
<span class="line"><span>~/projects/newapp/                &lt;- no .noorm</span></span>
<span class="line"><span>~/projects/                       &lt;- no .noorm</span></span>
<span class="line"><span>~/                                &lt;- has ~/.noorm but that&#39;s global, stop</span></span>
<span class="line"><span>                                  &lt;- result: no project found</span></span></code></pre></div><p>Once a project is found, noorm calls <code>process.chdir()</code> to the project root. This means all relative paths (settings, changes, SQL files) work correctly without modification.</p><h2 id="directory-hierarchy" tabindex="-1">Directory Hierarchy <a class="header-anchor" href="#directory-hierarchy" aria-label="Permalink to “Directory Hierarchy”">​</a></h2><table tabindex="0"><thead><tr><th>Path</th><th>Purpose</th><th>Treated as project?</th></tr></thead><tbody><tr><td><code>~/.noorm/</code></td><td>Global identity, secrets</td><td>No</td></tr><tr><td><code>~/projects/myapp/.noorm/</code></td><td>Project settings, state</td><td>Yes</td></tr><tr><td><code>~/projects/myapp/packages/db/</code></td><td>Subdirectory</td><td>Walks up to find project</td></tr></tbody></table><h2 id="api" tabindex="-1">API <a class="header-anchor" href="#api" aria-label="Permalink to “API”">​</a></h2><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    findProjectRoot,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    initProjectContext,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    isNoormProject,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    getGlobalNoormPath,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    hasGlobalNoorm,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./core/project.js&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Find project root without side effects</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> findProjectRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// result.projectRoot: &#39;/Users/me/projects/myapp&#39; or null</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// result.hasProject: true/false</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// result.homeNoorm: &#39;/Users/me/.noorm&#39; or null</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// result.originalCwd: where the user actually ran the command</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Find and chdir to project root (default behavior)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initProjectContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Now process.cwd() === result.projectRoot</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Find without chdir (for SDKs, testing)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initProjectContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ chdir: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Helper functions</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isNoormProject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/path/to/dir&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// checks if dir has .noorm/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getGlobalNoormPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()               </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// returns ~/.noorm path</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hasGlobalNoorm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()                   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// checks if ~/.noorm exists</span></span></code></pre></div><h2 id="cli-integration" tabindex="-1">CLI Integration <a class="header-anchor" href="#cli-integration" aria-label="Permalink to “CLI Integration”">​</a></h2><p>The CLI calls <code>initProjectContext()</code> at the very start of <code>main()</code>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // First thing: find project and chdir</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> projectDiscovery</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initProjectContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Now process.cwd() is the project root</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    enableAutoLoggerInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(process.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cwd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... rest of CLI initialization</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>If no project is found and the user is heading to the home screen, they&#39;re redirected to the init screen to create a project.</p><h2 id="sdk-usage" tabindex="-1">SDK Usage <a class="header-anchor" href="#sdk-usage" aria-label="Permalink to “SDK Usage”">​</a></h2><p>SDKs might want discovery without the automatic <code>chdir</code>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { findProjectRoot } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;noorm/core&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Find project root</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">projectRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">hasProject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> findProjectRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hasProject) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;No noorm project found&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Pass projectRoot explicitly to managers</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> settings</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SettingsManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(projectRoot)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StateManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(projectRoot)</span></span></code></pre></div><h2 id="edge-cases" tabindex="-1">Edge Cases <a class="header-anchor" href="#edge-cases" aria-label="Permalink to “Edge Cases”">​</a></h2><p><strong>Symlinks</strong>: On macOS, <code>/var/folders/...</code> is symlinked to <code>/private/var/folders/...</code>. The discovery uses <code>realpathSync</code> to resolve symlinks before comparing paths.</p><p><strong>Multiple projects</strong>: If nested projects exist (unlikely but possible), the nearest one wins:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>~/projects/outer/.noorm/</span></span>
<span class="line"><span>~/projects/outer/inner/.noorm/    &lt;- user is here</span></span>
<span class="line"><span>                                  &lt;- inner project found, not outer</span></span></code></pre></div><p><strong>No project, has identity</strong>: User has <code>~/.noorm/</code> with identity keys but no project. They&#39;re redirected to init to create a project in the current directory.</p><p><strong>No project, no identity</strong>: First-time user. They&#39;re redirected to init for identity creation, then project creation.</p>`,27)])])}const g=i(n,[["render",h]]);export{c as __pageData,g as default};
